<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Rack Visualization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .top-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .top-header h1 {
            font-size: 1.6em;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls-bar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 0.95em;
            width: 250px;
            transition: all 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102,126,234,0.3);
        }

        .zoom-group {
            display: flex;
            gap: 8px;
        }

        .zoom-btn, .sidebar-toggle-btn, .filter-toggle-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .zoom-btn:hover, .sidebar-toggle-btn:hover, .filter-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        .zoom-btn.active {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: white;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
            z-index: 50;
        }

        .sidebar.hidden {
            margin-left: -280px;
        }

        .sidebar-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .sidebar-header h3 {
            font-size: 1em;
            color: #2a5298;
        }

        .sidebar-content {
            padding: 12px;
            overflow-y: auto;
            flex: 1;
        }

        .customer-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .customer-item:hover {
            background: #e9ecef;
            transform: translateX(3px);
        }

        .customer-item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .customer-checkbox {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            cursor: pointer;
        }

        .customer-name {
            flex: 1;
            font-size: 0.75em;
            word-break: break-word;
            line-height: 1.3;
        }

        .customer-count {
            font-size: 0.7em;
            opacity: 0.8;
            margin-left: 6px;
        }

        .all-customers {
            font-weight: bold;
            background: #2a5298;
            color: white;
            margin-bottom: 12px;
        }

        .all-customers:hover {
            background: #1e3c72;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tabs-container {
            background: white;
            padding: 15px 30px 0 30px;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
            white-space: nowrap;
        }

        .tabs {
            display: inline-flex;
            gap: 5px;
        }

        .tab {
            padding: 12px 24px;
            background: #e9ecef;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #dee2e6;
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 -2px 10px rgba(102,126,234,0.3);
        }

        .tab.full-zone {
            color: #28a745;
            font-weight: bold;
        }

        .rack-container {
            flex: 1;
            padding: 20px;
            overflow: auto;
            background: #f8f9fa;
        }

        .analyze-container {
            display: none;
            padding: 40px;
            background: #f8f9fa;
            overflow: auto;
        }

        .analyze-container.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto 40px auto;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .stat-card .number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            display: block;
            margin-bottom: 10px;
        }

        .stat-card .label {
            font-size: 1.1em;
            color: #495057;
            font-weight: 600;
        }

        .zone-analysis {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            max-width: 1400px;
            margin: 0 auto;
        }

        .zone-analysis h3 {
            font-size: 1.4em;
            color: #2a5298;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .zone-table {
            width: 100%;
            border-collapse: collapse;
        }

        .zone-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .zone-table th {
            padding: 12px;
            text-align: left;
            font-size: 0.9em;
            font-weight: 600;
        }

        .zone-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }

        .zone-table tbody tr:hover {
            background: #f8f9fa;
        }

        .zone-table .zone-col {
            font-weight: bold;
            color: #667eea;
        }

        .zone-table .pct-col {
            font-weight: bold;
        }

        .pct-high {
            color: #28a745;
        }

        .pct-medium {
            color: #ffc107;
        }

        .pct-low {
            color: #dc3545;
        }

        .zone-content {
            display: none;
        }

        .zone-content.active {
            display: block;
        }

        .rack-matrix {
            display: inline-block;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transform-origin: top left;
            transition: transform 0.3s ease;
        }

        .rack-row {
            display: flex;
            gap: 3px;
            margin-bottom: 3px;
        }

        .row-label {
            width: 55px;
            min-width: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85em;
            color: #495057;
            background: #e9ecef;
            border-radius: 4px;
        }

        .rack-cell {
            width: 120px;
            min-width: 120px;
            height: 90px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            padding: 6px;
            position: relative;
            overflow: hidden;
            text-align: left;
        }

        .rack-cell.empty {
            background: #e9ecef;
            border-style: dashed;
            cursor: default;
        }

        .rack-cell.empty .cell-location {
            color: #adb5bd;
        }

        .rack-cell.occupied {
            border: 2px solid #333;
        }

        .rack-cell.filtered-out {
            background: #e9ecef !important;
            border-style: dashed !important;
            border-color: #ddd !important;
            cursor: default;
        }

        .rack-cell.filtered-out .cell-location {
            color: #000000 !important;
        }

        .rack-cell.filtered-out .cell-owner,
        .rack-cell.filtered-out .cell-item,
        .rack-cell.filtered-out .cell-qty,
        .rack-cell.filtered-out .cell-badge {
            display: none;
        }

        .rack-cell.highlight {
            animation: pulse 1s infinite;
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 0 20px rgba(255,107,107,0.8);
            border: 3px solid #ff6b6b;
        }

        .rack-cell:hover:not(.filtered-out):not(.empty) {
            transform: scale(1.05);
            z-index: 5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255,107,107,0.6); }
            50% { box-shadow: 0 0 30px rgba(255,107,107,0.9); }
        }

        .cell-location {
            font-weight: bold;
            font-size: 0.85em;
            margin-bottom: 3px;
            color: #212529;
            width: 100%;
        }

        .cell-owner {
            font-size: 0.7em;
            color: #495057;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
            margin-bottom: 2px;
        }

        .cell-item {
            font-size: 0.68em;
            color: #6c757d;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cell-qty {
            font-size: 0.68em;
            color: #495057;
            font-weight: 600;
            margin-top: 1px;
        }

        .cell-badge {
            position: absolute;
            top: 3px;
            right: 3px;
            background: rgba(255,255,255,0.95);
            color: #495057;
            font-size: 0.65em;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        /* Modal Styles - NEW STYLE KEPT */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-header h2 {
            color: #2c3e50;
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #e74c3c;
        }

        .item-details {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .item-details:last-child {
            margin-bottom: 0;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .detail-row:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: bold;
            color: #34495e;
        }

        .detail-value {
            color: #2c3e50;
        }

        .status-movable {
            color: #27ae60;
            font-weight: bold;
        }

        .status-hold {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-damaged {
            color: #e67e22;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                height: 100%;
                z-index: 100;
            }
            
            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-group, .zoom-group {
                width: 100%;
                justify-content: center;
            }

            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="top-header">
            <h1>üè≠ Warehouse Rack Visualization System</h1>
        </div>

        <div class="controls-bar">
            <div class="search-group">
                <input type="text" class="search-box" id="searchBox" placeholder="üîç Search location (e.g., A-1-24)">
                <button class="filter-toggle-btn" id="filterToggle">Hide Filters</button>
            </div>
            <div class="zoom-group">
                <button class="zoom-btn active" data-zoom="100">100%</button>
                <button class="zoom-btn" data-zoom="75">75%</button>
                <button class="zoom-btn" data-zoom="fit">Fit Width</button>
            </div>
        </div>

        <div class="main-layout">
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h3>üìã Filter by Customer</h3>
                </div>
                <div class="sidebar-content" id="sidebarContent">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <div class="content-area">
                <div class="tabs-container">
                    <div class="tabs" id="tabs">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <div class="analyze-container" id="analyzeView">
                    <!-- Analyze view will be populated by JavaScript -->
                </div>

                <div class="rack-container" id="rackContainer">
                    <div id="zoneViews">
                        <!-- Zone views will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Location Details</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Load the rack data from external file -->
    <script src="rack_data.js"></script>
    
    <script>
        // Application state
        let currentView = 'Analyze';
        let currentZoom = 100;
        let selectedCustomers = new Set();
        let allCustomers = new Set();
        let customerItemCounts = {};

        // Initialize the application
        function init() {
            if (typeof rackData === 'undefined' || typeof analyzeData === 'undefined') {
                alert('Error: Data file not loaded. Please make sure rack_data.js is in the same directory.');
                return;
            }

            collectAllCustomers();
            createTabs();
            createCustomerFilter();
            createAnalyzeView();
            createRackViews();
            setupEventListeners();
            switchView('Analyze');
        }

        function collectAllCustomers() {
            for (const zone in rackData) {
                for (const level in rackData[zone]) {
                    for (const bay in rackData[zone][level]) {
                        const location = rackData[zone][level][bay];
                        if (location.items) {
                            location.items.forEach(item => {
                                const owner = item.owner;
                                allCustomers.add(owner);
                                customerItemCounts[owner] = (customerItemCounts[owner] || 0) + 1;
                            });
                        }
                    }
                }
            }
        }

        function createTabs() {
            const tabsContainer = document.getElementById('tabs');
            tabsContainer.innerHTML = '';
            
            const analyzeTab = document.createElement('button');
            analyzeTab.className = 'tab active';
            analyzeTab.textContent = 'Analyze';
            analyzeTab.dataset.view = 'Analyze';
            tabsContainer.appendChild(analyzeTab);

            const zones = Object.keys(rackData).sort((a, b) => {
                const getOrder = (z) => {
                    if (z.length === 1) return [1, z.charCodeAt(0), 0];
                    if (z.length === 2 && z[1] >= '1' && z[1] <= '6') return [3, z.charCodeAt(0), parseInt(z[1])];
                    return [2, z.charCodeAt(0), z.charCodeAt(1)];
                };
                const [aType, aChar, aNum] = getOrder(a);
                const [bType, bChar, bNum] = getOrder(b);
                if (aType !== bType) return aType - bType;
                if (aChar !== bChar) return aChar - bChar;
                return aNum - bNum;
            });

            zones.forEach(zone => {
                const tab = document.createElement('button');
                tab.className = 'tab';
                tab.textContent = zone;
                tab.dataset.view = zone;
                tabsContainer.appendChild(tab);
            });
        }

        function createCustomerFilter() {
            const sidebarContent = document.getElementById('sidebarContent');
            sidebarContent.innerHTML = '';
            
            const allItem = document.createElement('div');
            allItem.className = 'customer-item all-customers';
            allItem.innerHTML = `
                <input type="checkbox" id="customer-all" class="customer-checkbox" checked>
                <label for="customer-all" class="customer-name">All Customers</label>
            `;
            sidebarContent.appendChild(allItem);

            const sortedCustomers = Array.from(allCustomers).sort();
            sortedCustomers.forEach(customer => {
                const count = customerItemCounts[customer] || 0;
                const item = document.createElement('div');
                item.className = 'customer-item';
                const customerId = 'customer-' + customer.replace(/[^a-zA-Z0-9]/g, '');
                item.innerHTML = `
                    <input type="checkbox" id="${customerId}" data-customer="${customer}" class="customer-checkbox" checked>
                    <label for="${customerId}" class="customer-name">
                        ${customer.substring(0, 30)}
                        <span class="customer-count">(${count})</span>
                    </label>
                `;
                sidebarContent.appendChild(item);
            });

            selectedCustomers = new Set(allCustomers);
        }

        function createAnalyzeView() {
            const analyzeView = document.getElementById('analyzeView');

            let totalCapacity = 0;
            let totalUsed = 0;
            analyzeData.forEach(row => {
                totalCapacity += row.capacity;
                totalUsed += row.used;
            });
            const occupancyRate = ((totalUsed / totalCapacity) * 100).toFixed(1);

            analyzeView.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="number">${totalCapacity.toLocaleString()}</span>
                        <span class="label">Total Locations</span>
                    </div>
                    <div class="stat-card">
                        <span class="number">${totalUsed.toLocaleString()}</span>
                        <span class="label">Occupied Locations</span>
                    </div>
                    <div class="stat-card">
                        <span class="number">${occupancyRate}%</span>
                        <span class="label">Occupancy Rate</span>
                    </div>
                </div>

                <div class="zone-analysis">
                    <h3>üìä Zone Analysis</h3>
                    <table class="zone-table">
                        <thead>
                            <tr>
                                <th>Zone</th>
                                <th>Capacity</th>
                                <th>L1</th>
                                <th>L2</th>
                                <th>L3</th>
                                <th>L4</th>
                                <th>L5</th>
                                <th>L6</th>
                                <th>L7</th>
                                <th>Used</th>
                                <th>Empty</th>
                                <th>Occupied %</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analyzeData.map(row => {
                                const pct = (row.occupiedPct * 100).toFixed(1);
                                let pctClass = 'pct-low';
                                if (pct >= 70) pctClass = 'pct-high';
                                else if (pct >= 40) pctClass = 'pct-medium';

                                return `
                                    <tr>
                                        <td class="zone-col">${row.zone}</td>
                                        <td>${row.capacity}</td>
                                        <td>${row.level1}</td>
                                        <td>${row.level2}</td>
                                        <td>${row.level3}</td>
                                        <td>${row.level4}</td>
                                        <td>${row.level5}</td>
                                        <td>${row.level6}</td>
                                        <td>${row.level7}</td>
                                        <td><strong>${row.used}</strong></td>
                                        <td>${row.empty}</td>
                                        <td class="pct-col ${pctClass}">${pct}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function createRackViews() {
            const zoneViews = document.getElementById('zoneViews');
            zoneViews.innerHTML = '';

            for (const zone in rackData) {
                const zoneContent = document.createElement('div');
                zoneContent.className = 'zone-content';
                zoneContent.id = `zone-${zone}`;
                
                const matrix = createMatrix(zone);
                const matrixDiv = document.createElement('div');
                matrixDiv.className = 'rack-matrix';
                matrixDiv.innerHTML = matrix;
                
                zoneContent.appendChild(matrixDiv);
                zoneViews.appendChild(zoneContent);
            }
        }

        function createMatrix(zone) {
            let html = '';
            
            for (let level = 7; level >= 1; level--) {
                html += '<div class="rack-row">';
                html += `<div class="row-label">Level ${level}</div>`;
                
                for (let bay = 1; bay <= 24; bay++) {
                    const location = rackData[zone]?.[level]?.[bay];
                    
                    if (location && location.items && location.items.length > 0) {
                        const firstItem = location.items[0];
                        const itemCount = location.items.length;
                        const color = getOwnerColor(firstItem.owner);
                        
                        html += `
                            <div class="rack-cell occupied" 
                                 data-zone="${zone}" 
                                 data-level="${level}" 
                                 data-bay="${bay}"
                                 data-owner="${firstItem.owner}"
                                 style="background-color: ${color}20; border-color: ${color};">
                                <div class="cell-location">${location.location}</div>
                                <div class="cell-owner">${truncate(firstItem.owner, 20)}</div>
                                <div class="cell-item">${firstItem.itemCode}</div>
                                <div class="cell-item">${truncate(firstItem.itemName, 15)}</div>
                                <div class="cell-qty">${firstItem.quantity} ${firstItem.uom}</div>
                                ${itemCount > 1 ? `<div class="cell-badge">${itemCount}</div>` : ''}
                            </div>
                        `;
                    } else {
                        const locationId = `${zone}-${level}-${bay}`;
                        html += `
                            <div class="rack-cell empty" data-location="${locationId}">
                                <div class="cell-location">${locationId}</div>
                            </div>
                        `;
                    }
                }
                
                html += '</div>';
            }
            
            return html;
        }

        function getOwnerColor(owner) {
            if (!owner) return '#95a5a6';
            
            let hash = 0;
            for (let i = 0; i < owner.length; i++) {
                hash = owner.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const colors = [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#e67e22', '#34495e', '#16a085', '#27ae60',
                '#2980b9', '#8e44ad', '#c0392b', '#d35400', '#7f8c8d',
                '#c0392b', '#16a085', '#27ae60', '#8e44ad', '#2c3e50',
                '#f1c40f', '#e67e22', '#95a5a6', '#34495e'
            ];
            
            return colors[Math.abs(hash) % colors.length];
        }

        function truncate(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) : text;
        }

        function switchView(view) {
            currentView = view;
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.view === view) {
                    tab.classList.add('active');
                }
            });

            if (view === 'Analyze') {
                document.getElementById('analyzeView').classList.add('active');
                document.getElementById('rackContainer').style.display = 'none';
            } else {
                document.getElementById('analyzeView').classList.remove('active');
                document.getElementById('rackContainer').style.display = 'block';
                
                document.querySelectorAll('.zone-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                const targetZone = document.getElementById(`zone-${view}`);
                if (targetZone) {
                    targetZone.classList.add('active');
                }
                
                updateTabColors();
            }
        }

        function updateTabColors() {
            if (selectedCustomers.size === allCustomers.size) {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('full-zone');
                });
                return;
            }

            for (const zone in rackData) {
                let hasAnyLocation = false;
                let allOccupied = true;

                for (let level = 1; level <= 7; level++) {
                    for (let bay = 1; bay <= 24; bay++) {
                        const location = rackData[zone]?.[level]?.[bay];
                        
                        if (location && location.items && location.items.length > 0) {
                            const hasSelectedCustomer = location.items.some(item => 
                                selectedCustomers.has(item.owner)
                            );

                            if (hasSelectedCustomer) {
                                hasAnyLocation = true;
                            }
                        } else {
                            allOccupied = false;
                        }
                    }
                }

                const tab = document.querySelector(`.tab[data-view="${zone}"]`);
                if (tab) {
                    if (hasAnyLocation && allOccupied) {
                        tab.classList.add('full-zone');
                    } else {
                        tab.classList.remove('full-zone');
                    }
                }
            }
        }

        function applyCustomerFilter() {
            const cells = document.querySelectorAll('.rack-cell.occupied');
            
            cells.forEach(cell => {
                const owner = cell.dataset.owner;
                
                if (selectedCustomers.has(owner)) {
                    cell.classList.remove('filtered-out');
                    cell.style.pointerEvents = 'auto';
                } else {
                    cell.classList.add('filtered-out');
                    cell.style.pointerEvents = 'none';
                }
            });

            updateTabColors();
        }

        function showModal(zone, level, bay) {
            const location = rackData[zone]?.[level]?.[bay];
            if (!location || !location.items || location.items.length === 0) return;

            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `Location: ${location.location}`;

            let html = '';
            location.items.forEach((item) => {
                const color = getOwnerColor(item.owner);
                
                let statusText = 'Movable';
                let statusClass = 'status-movable';
                if (item.damageFlag === 'Held') {
                    statusText = 'Hold';
                    statusClass = 'status-hold';
                } else if (item.damageFlag === 'Damaged') {
                    statusText = 'Damaged';
                    statusClass = 'status-damaged';
                }

                html += `
                    <div class="item-details" style="border-left-color: ${color};">
                        <div class="detail-row">
                            <div class="detail-label">Owner:</div>
                            <div class="detail-value">${item.owner}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Item Code:</div>
                            <div class="detail-value">${item.itemCode}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Item Name:</div>
                            <div class="detail-value">${item.itemName}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Quantity:</div>
                            <div class="detail-value">${item.quantity} ${item.uom}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Status:</div>
                            <div class="detail-value ${statusClass}">${statusText}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Date:</div>
                            <div class="detail-value">${item.lot6 || '-'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Lot1:</div>
                            <div class="detail-value">${item.lot1 || '-'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Lot2:</div>
                            <div class="detail-value">${item.lot2 || '-'}</div>
                        </div>
                    </div>
                `;
            });

            modalBody.innerHTML = html;
            modal.classList.add('active');
        }

        function searchLocation(query) {
            query = query.trim().toUpperCase();
            if (!query) {
                clearHighlights();
                return;
            }

            clearHighlights();

            const parts = query.split('-');
            if (parts.length === 3) {
                const [zone, level, bay] = parts;
                
                if (rackData[zone]) {
                    switchView(zone);
                    
                    setTimeout(() => {
                        const cell = document.querySelector(
                            `.rack-cell[data-zone="${zone}"][data-level="${level}"][data-bay="${bay}"]`
                        );
                        if (cell) {
                            cell.classList.add('highlight');
                            cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            }
        }

        function clearHighlights() {
            document.querySelectorAll('.rack-cell.highlight').forEach(cell => {
                cell.classList.remove('highlight');
            });
        }

        function setupEventListeners() {
            document.getElementById('tabs').addEventListener('click', (e) => {
                if (e.target.classList.contains('tab')) {
                    switchView(e.target.dataset.view);
                }
            });

            document.getElementById('zoneViews').addEventListener('click', (e) => {
                const cell = e.target.closest('.rack-cell');
                if (cell && cell.classList.contains('occupied') && !cell.classList.contains('filtered-out')) {
                    const zone = cell.dataset.zone;
                    const level = parseInt(cell.dataset.level);
                    const bay = parseInt(cell.dataset.bay);
                    showModal(zone, level, bay);
                }
            });

            document.getElementById('closeModal').addEventListener('click', () => {
                document.getElementById('modal').classList.remove('active');
            });

            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target.id === 'modal') {
                    document.getElementById('modal').classList.remove('active');
                }
            });

            document.querySelectorAll('.zoom-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.zoom-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const zoom = btn.dataset.zoom;
                    const matrices = document.querySelectorAll('.rack-matrix');
                    
                    if (zoom === 'fit') {
                        const container = document.getElementById('rackContainer');
                        matrices.forEach(matrix => {
                            const containerWidth = container.clientWidth - 40;
                            const matrixWidth = 55 + (24 * 123);
                            const scale = Math.min(containerWidth / matrixWidth, 1);
                            matrix.style.transform = `scale(${scale})`;
                        });
                    } else {
                        const scale = parseInt(zoom) / 100;
                        matrices.forEach(matrix => {
                            matrix.style.transform = `scale(${scale})`;
                        });
                    }
                });
            });

            let searchTimeout;
            document.getElementById('searchBox').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchLocation(e.target.value);
                }, 300);
            });

            document.getElementById('filterToggle').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                const btn = document.getElementById('filterToggle');
                
                if (sidebar.classList.contains('hidden')) {
                    sidebar.classList.remove('hidden');
                    btn.textContent = 'Hide Filters';
                } else {
                    sidebar.classList.add('hidden');
                    btn.textContent = 'Show Filters';
                }
            });

            document.getElementById('sidebarContent').addEventListener('change', (e) => {
                if (e.target.id === 'customer-all') {
                    const checkboxes = document.querySelectorAll('.customer-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = e.target.checked;
                    });
                    
                    if (e.target.checked) {
                        selectedCustomers = new Set(allCustomers);
                    } else {
                        selectedCustomers.clear();
                    }
                } else if (e.target.classList.contains('customer-checkbox')) {
                    const customer = e.target.dataset.customer;
                    
                    if (e.target.checked) {
                        selectedCustomers.add(customer);
                    } else {
                        selectedCustomers.delete(customer);
                    }
                    
                    const allCheckbox = document.getElementById('customer-all');
                    allCheckbox.checked = selectedCustomers.size === allCustomers.size;
                }
                
                applyCustomerFilter();
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
