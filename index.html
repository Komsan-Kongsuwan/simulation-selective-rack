<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selective Rack Simulation</title>
    <!-- SheetJS library for Excel file reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PapaParse library for CSV file reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 30px);
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            padding: 15px 25px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-box {
            display: flex;
            gap: 10px;
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            flex: 1;
            padding: 10px 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .search-box button {
            padding: 10px 22px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .search-box button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .control-buttons button {
            padding: 10px 18px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .control-buttons button:hover {
            background: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(42,82,152,0.3);
        }

        .control-buttons button.active {
            background: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
        }

        .tabs-container {
            background: #f8f9fa;
            padding: 0 15px;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
            white-space: nowrap;
        }

        .tabs {
            display: inline-flex;
            gap: 4px;
            min-width: 100%;
        }

        .tab {
            padding: 12px 20px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            color: #495057;
        }

        .tab:hover {
            background: #dee2e6;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab.empty-tab {
            color: #999;
        }

        .tab.empty-tab.active {
            color: #999;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-right: 2px solid #dee2e6;
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
            position: relative;
            z-index: 10;
        }

        .sidebar.hidden {
            margin-left: -280px;
        }

        .sidebar-toggle-btn {
            position: absolute;
            right: -35px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            border: none;
            padding: 20px 8px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            z-index: 5;
        }

        .sidebar-toggle-btn:hover {
            background: #5568d3;
        }

        .sidebar-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .sidebar-header h3 {
            font-size: 1em;
            color: #2a5298;
        }

        .sidebar-content {
            padding: 12px;
            overflow-y: auto;
            flex: 1;
        }

        .filter-section {
            margin-bottom: 20px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .filter-section h4 {
            font-size: 0.9em;
            color: #2a5298;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .aging-option {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .aging-option:hover {
            background: #e9ecef;
        }

        .aging-option input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .aging-option label {
            cursor: pointer;
            font-size: 0.9em;
            flex: 1;
        }

        .customer-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .customer-item:hover {
            background: #e9ecef;
            transform: translateX(3px);
        }

        .customer-item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .customer-checkbox {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            cursor: pointer;
        }

        .customer-name {
            flex: 1;
            font-size: 0.75em;
            word-break: break-word;
            line-height: 1.3;
        }

        .customer-count {
            font-size: 0.7em;
            opacity: 0.8;
            margin-left: 6px;
        }

        .all-customers {
            font-weight: bold;
            background: #2a5298;
            color: white;
            margin-bottom: 12px;
        }

        .all-customers:hover {
            background: #1e3c72;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .rack-container {
            flex: 1;
            padding: 20px;
            overflow: auto;
            background: #f8f9fa;
        }

        .analyze-container {
            display: none;
            padding: 40px;
            background: #f8f9fa;
            overflow: auto;
        }

        .analyze-container.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .stat-card .number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            display: block;
            margin-bottom: 10px;
        }

        .stat-card .label {
            font-size: 1.1em;
            color: #495057;
            font-weight: 600;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 30px auto 0;
        }

        .chart-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        #customerChart {
            max-height: 600px;
            overflow-y: auto;
        }

        .chart-bar-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .chart-bar-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .chart-bar-label {
            width: 200px;
            min-width: 200px;
            font-size: 0.9em;
            color: #495057;
            font-weight: 500;
            padding-right: 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chart-bar-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-bar-bg {
            flex: 1;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
        }

        .chart-bar-percentage {
            color: white;
            font-size: 0.85em;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .chart-bar-count {
            min-width: 60px;
            text-align: right;
            font-size: 0.9em;
            color: #495057;
            font-weight: 600;
        }

        .chart-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .chart-label {
            min-width: 150px;
            font-weight: 600;
            color: #495057;
            text-align: right;
            font-size: 0.95em;
        }

        .chart-bar-container {
            flex: 1;
            background: #e9ecef;
            border-radius: 8px;
            height: 35px;
            position: relative;
            overflow: hidden;
        }

        .chart-bar {
            height: 100%;
            border-radius: 8px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .chart-percentage {
            min-width: 60px;
            text-align: right;
            font-weight: 600;
            color: #667eea;
            font-size: 0.95em;
        }

        .zone-content {
            display: none;
        }

        .zone-content.active {
            display: block;
        }

        .rack-matrix {
            display: inline-block;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transform-origin: top left;
            transition: transform 0.3s ease;
        }

        .rack-row {
            display: flex;
            gap: 3px;
            margin-bottom: 3px;
        }

        .row-label {
            width: 55px;
            min-width: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85em;
            color: #495057;
            background: #e9ecef;
            border-radius: 4px;
        }

        .rack-cell {
            width: 120px;
            min-width: 120px;
            height: 90px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            padding: 6px;
            position: relative;
            overflow: hidden;
            text-align: left;
        }

        .rack-cell.empty {
            background: #e9ecef;
            border-style: dashed;
        }

        .rack-cell.empty .cell-location {
            color: #adb5bd;
        }

        .rack-cell.occupied {
            border: 2px solid #333;
        }

        .rack-cell.filtered-out {
            background: #e9ecef !important;
            border-style: dashed !important;
            border-color: #ddd !important;
        }

        .rack-cell.filtered-out .cell-location {
            color: #adb5bd;
        }

        .rack-cell.filtered-out .cell-owner,
        .rack-cell.filtered-out .cell-item,
        .rack-cell.filtered-out .cell-qty,
        .rack-cell.filtered-out .cell-badge {
            display: none;
        }

        .rack-cell.highlight {
            animation: pulse 1s infinite;
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 0 20px rgba(255,107,107,0.8);
            border: 3px solid #ff6b6b;
        }

        .rack-cell:hover:not(.filtered-out) {
            transform: scale(1.05);
            z-index: 5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255,107,107,0.6); }
            50% { box-shadow: 0 0 30px rgba(255,107,107,0.9); }
        }

        .cell-location {
            font-weight: bold;
            font-size: 0.85em;
            margin-bottom: 3px;
            color: #212529;
            width: 100%;
        }

        .cell-owner {
            font-size: 0.7em;
            color: #495057;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
            margin-bottom: 2px;
        }

        .cell-item {
            font-size: 0.68em;
            color: #6c757d;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cell-qty {
            font-size: 0.68em;
            color: #495057;
            font-weight: 600;
            margin-top: 1px;
        }

        .cell-badge {
            position: absolute;
            top: 3px;
            right: 3px;
            background: rgba(255,255,255,0.95);
            color: #495057;
            font-size: 0.65em;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.6em;
        }

        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            line-height: 1;
        }

        .close:hover {
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px;
            max-height: calc(85vh - 100px);
            overflow-y: auto;
        }

        .item-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 18px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            transition: all 0.3s;
        }

        .item-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .item-card h3 {
            color: #2a5298;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .item-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .info-row {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 0.8em;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .info-value {
            font-weight: 600;
            color: #212529;
            word-break: break-word;
        }

        .empty-location {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 1.1em;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #667eea;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 220px;
            }
            
            .sidebar.hidden {
                margin-left: -220px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .tab {
                padding: 10px 16px;
                font-size: 0.85em;
            }

            .controls {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .control-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .rack-cell {
                width: 90px;
                min-width: 90px;
                height: 70px;
                font-size: 0.8em;
            }

            .row-label {
                width: 45px;
                min-width: 45px;
                font-size: 0.75em;
            }

            .sidebar {
                width: 180px;
            }
            
            .sidebar.hidden {
                margin-left: -180px;
            }
        }

        /* File Upload Modal Styles */
        .file-upload-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .file-upload-overlay.show {
            display: flex;
        }

        .file-upload-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
        }

        .file-upload-container h2 {
            color: #2a5298;
            margin-bottom: 20px;
            text-align: center;
        }

        .file-input-group {
            margin-bottom: 25px;
        }

        .file-input-group label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .file-input-group input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-group input[type="file"]:hover {
            border-color: #5568d3;
            background: #f8f9ff;
        }

        .file-name-display {
            margin-top: 5px;
            font-size: 0.9em;
            color: #28a745;
            font-weight: 500;
        }

        .load-files-button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .load-files-button:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .load-files-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .file-error-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 10px;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
            display: none;
        }

        .file-loading-spinner {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .file-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .cancel-upload-btn {
            width: 100%;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .cancel-upload-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Selective Rack Simulation</h1>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search location (e.g., A-1-1)">
                <button onclick="searchLocation()">Search</button>
                <button onclick="clearSearch()" style="background: #6c757d;">Clear</button>
            </div>
            <div class="control-buttons">
                <button onclick="showFileUploadModal()" style="background: #28a745;">üìÅ Load Files</button>
                <button onclick="setZoom('100')" id="zoom100" class="active">100%</button>
                <button onclick="setZoom('75')" id="zoom75">75%</button>
                <button onclick="setZoom('fit')" id="zoomFit">Fit Width</button>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tabs" id="tabs">
                <button class="tab" onclick="switchMainTab('analyze')">Analyze</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar" id="sidebar">
                <button class="sidebar-toggle-btn" id="sidebarToggle" onclick="toggleSidebar()">Hide</button>
                <div class="sidebar-header">
                    <h3>Filters</h3>
                </div>
                <div class="sidebar-content">
                    <div class="filter-section">
                        <h4>Stock Aging</h4>
                        <div class="aging-option">
                            <input type="radio" id="agingAll" name="agingFilter" checked onchange="applyFilter()">
                            <label for="agingAll">All</label>
                        </div>
                        <div class="aging-option">
                            <input type="radio" id="aging6months" name="agingFilter" onchange="applyFilter()">
                            <label for="aging6months">‚â§ 6 months (0-6 months)</label>
                        </div>
                        <div class="aging-option">
                            <input type="radio" id="aging1year" name="agingFilter" onchange="applyFilter()">
                            <label for="aging1year">> 6 months</label>
                        </div>
                        <div class="aging-option">
                            <input type="radio" id="aging2years" name="agingFilter" onchange="applyFilter()">
                            <label for="aging2years">> 1 year</label>
                        </div>
                        <div class="aging-option">
                            <input type="radio" id="agingOver2years" name="agingFilter" onchange="applyFilter()">
                            <label for="agingOver2years">> 2 years</label>
                        </div>
                    </div>
                    <div class="filter-section">
                        <h4>Customer</h4>
                        <div id="customerList">
                            <!-- Customer list will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-area">
                <div class="rack-container" id="rackContainer">
                    <div id="loadingMessage" class="loading">Loading rack data...</div>
                    <div id="zoneContents"></div>
                </div>

                <div class="analyze-container" id="analyzeContainer">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="number" id="totalLocations">-</span>
                            <span class="label">Total Locations</span>
                        </div>
                        <div class="stat-card">
                            <span class="number" id="occupiedLocations">-</span>
                            <span class="label">Occupied Locations</span>
                        </div>
                        <div class="stat-card">
                            <span class="number" id="occupancyRate">-</span>
                            <span class="label">Occupancy Rate</span>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">Customer Location Occupation</div>
                        <div id="customerChart"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="locationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Location Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be dynamically inserted -->
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div id="fileUploadOverlay" class="file-upload-overlay">
        <div class="file-upload-container">
            <h2>Load Data Files</h2>
            
            <div class="file-input-group">
                <label for="excelFile">Rack Locations (Excel file):</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls" />
                <div id="excelFileName" class="file-name-display"></div>
            </div>
            
            <div class="file-input-group">
                <label for="csvFile">Stock Locations (CSV file):</label>
                <input type="file" id="csvFile" accept=".csv" />
                <div id="csvFileName" class="file-name-display"></div>
            </div>
            
            <button id="loadFilesBtn" class="load-files-button" disabled>Load Data</button>
            <button class="cancel-upload-btn" onclick="hideFileUploadModal()">Cancel</button>
            
            <div id="fileLoadingSpinner" class="file-loading-spinner">
                <div class="file-spinner"></div>
                <p style="margin-top: 15px; color: #667eea; font-weight: 600;">Processing files...</p>
            </div>
            
            <div id="fileErrorMessage" class="file-error-message"></div>
        </div>
    </div>

    <script>
        let RACK_DATA = null;
        let currentZone = null;
        let allCells = new Map();
        let currentZoom = '100';
        let selectedCustomers = new Set();
        let allCustomers = new Set();
        let customerCounts = {};
        let sidebarVisible = true;
        let currentMainTab = 'rack';
        let latestDate = null;
        
        let excelFileData = null;
        let csvFileData = null;

        // File upload modal functions
        function showFileUploadModal() {
            document.getElementById('fileUploadOverlay').classList.add('show');
            // Reset file inputs
            document.getElementById('excelFile').value = '';
            document.getElementById('csvFile').value = '';
            document.getElementById('excelFileName').textContent = '';
            document.getElementById('csvFileName').textContent = '';
            document.getElementById('fileErrorMessage').style.display = 'none';
            excelFileData = null;
            csvFileData = null;
            checkFilesReady();
        }

        function hideFileUploadModal() {
            document.getElementById('fileUploadOverlay').classList.remove('show');
        }

        // File upload handlers
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('excelFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    excelFileData = file;
                    document.getElementById('excelFileName').textContent = `‚úì ${file.name}`;
                    checkFilesReady();
                }
            });

            document.getElementById('csvFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    csvFileData = file;
                    document.getElementById('csvFileName').textContent = `‚úì ${file.name}`;
                    checkFilesReady();
                }
            });

            document.getElementById('loadFilesBtn').addEventListener('click', async function() {
                document.getElementById('fileErrorMessage').style.display = 'none';
                document.getElementById('fileLoadingSpinner').style.display = 'block';
                this.disabled = true;

                try {
                    await processFiles();
                    hideFileUploadModal();
                    reloadDataDisplay();
                } catch (error) {
                    console.error('Error processing files:', error);
                    document.getElementById('fileErrorMessage').textContent = 'Error: ' + error.message;
                    document.getElementById('fileErrorMessage').style.display = 'block';
                    this.disabled = false;
                } finally {
                    document.getElementById('fileLoadingSpinner').style.display = 'none';
                }
            });
            
            // Search input enter key
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });
            
            // Load initial data
            loadInitialData();
        });

        function checkFilesReady() {
            const loadBtn = document.getElementById('loadFilesBtn');
            if (excelFileData && csvFileData) {
                loadBtn.disabled = false;
            } else {
                loadBtn.disabled = true;
            }
        }

        async function processFiles() {
            // Read Excel file
            const excelData = await readExcelFile(excelFileData);
            
            // Read CSV file
            const csvData = await readCSVFile(csvFileData);
            
            // Convert to RACK_DATA format
            RACK_DATA = convertToRackData(excelData, csvData);
            
            console.log('Data loaded successfully:', RACK_DATA);
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function readCSVFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    complete: function(results) {
                        resolve(results.data);
                    },
                    error: reject
                });
            });
        }

        function convertToRackData(excelData, csvData) {
            // Process CSV to create stock lookup
            const stockByLocation = {};
            let maxDate = null;

            csvData.forEach(row => {
                const location = row['Location'];
                if (location && location.trim()) {
                    if (!stockByLocation[location]) {
                        stockByLocation[location] = [];
                    }
                    
                    const lot6 = row['Lot6'];
                    const lot2 = row['Lot2'];
                    const damageFlag = row['Damage Flag'];
                    
                    if (lot6) {
                        const itemDate = parseDDMMYYYY(lot6);
                        if (itemDate && (!maxDate || itemDate > maxDate)) {
                            maxDate = itemDate;
                        }
                    }
                    
                    stockByLocation[location].push({
                        ownerCode: row['Owner Code'] || '',
                        ownerName: row['Owner Name'] || '',
                        itemCode: row['Item Code'] || '',
                        itemName: row['Item Name'] || '',
                        stockQty: parseFloat(row['StockQty[Unit1]']) || 0,
                        uom: row['UOM1'] || '',
                        lot6: lot6 || '',
                        lot2: lot2 || '',
                        damageFlag: damageFlag || ''
                    });
                }
            });

            // Get unique owners and assign colors
            const uniqueOwners = [...new Set(csvData.map(row => row['Owner Name']).filter(Boolean))];
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788'];
            const ownerColors = {};
            uniqueOwners.forEach((owner, i) => {
                ownerColors[owner] = colors[i % colors.length];
            });

            const rackData = {
                zones: {},
                totalLocations: 0,
                occupiedLocations: 0,
                ownerColors: ownerColors,
                latestDate: maxDate ? formatDateToDDMMYYYY(maxDate) : null
            };

            // Detect Excel format
            const isNewFormat = Array.isArray(excelData[0]) && 
                                excelData[0].includes('Sheet') && 
                                excelData[0].includes('Location');
            
            if (isNewFormat) {
                // New format: has columns Sheet, Location, Level, etc.
                console.log('Detected new Excel format (with Sheet, Location columns)');
                
                // Convert array of arrays to array of objects
                const headers = excelData[0];
                const rows = excelData.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = row[i];
                    });
                    return obj;
                });

                // Group by Sheet (zone)
                const zoneGroups = {};
                rows.forEach(row => {
                    const zoneName = row['Sheet'];
                    const location = row['Location'];
                    
                    if (zoneName && location) {
                        if (!zoneGroups[zoneName]) {
                            zoneGroups[zoneName] = [];
                        }
                        zoneGroups[zoneName].push(location);
                    }
                });

                // Process each zone
                Object.keys(zoneGroups).sort().forEach(zoneName => {
                    const locations = zoneGroups[zoneName];
                    const zoneData = { matrix: [] };
                    const rackDict = {};

                    locations.forEach(location => {
                        try {
                            const parts = location.split('-');
                            if (parts.length >= 2) {
                                // Extract level and bay from location
                                // Format: A09-01 or similar
                                const levelPart = parts[0]; // e.g., "A09"
                                const bayPart = parts[1];   // e.g., "01"
                                
                                // Extract numeric level from levelPart
                                const levelMatch = levelPart.match(/\d+$/);
                                const level = levelMatch ? parseInt(levelMatch[0]) : 1;
                                const bay = parseInt(bayPart);
                                
                                if (!rackDict[level]) {
                                    rackDict[level] = {};
                                }
                                rackDict[level][bay] = location;
                            }
                        } catch (e) {
                            console.error('Error parsing location:', location, e);
                        }
                    });

                    // Build matrix
                    if (Object.keys(rackDict).length > 0) {
                        const maxLevel = Math.max(...Object.keys(rackDict).map(Number));
                        const maxBay = Math.max(...Object.values(rackDict).map(levelData => 
                            Math.max(...Object.keys(levelData).map(Number))
                        ));

                        // Create matrix (top level first)
                        for (let level = maxLevel; level >= 1; level--) {
                            const row = [];
                            for (let bay = 1; bay <= maxBay; bay++) {
                                if (rackDict[level] && rackDict[level][bay]) {
                                    const location = rackDict[level][bay];
                                    rackData.totalLocations++;

                                    const items = stockByLocation[location] || [];
                                    const occupied = items.length > 0;

                                    if (occupied) {
                                        rackData.occupiedLocations++;
                                    }

                                    row.push({
                                        location: location,
                                        occupied: occupied,
                                        items: items
                                    });
                                } else {
                                    row.push(null);
                                }
                            }
                            zoneData.matrix.push(row);
                        }
                    }

                    rackData.zones[zoneName] = zoneData;
                });

            } else {
                // Old format: each column is a zone
                console.log('Detected old Excel format (columns are zones)');
                
                const headers = excelData[0];

                headers.forEach((zoneName, colIndex) => {
                    const zoneData = { matrix: [] };
                    const rackDict = {};

                    // Get all locations in this column (skip header row)
                    for (let rowIndex = 1; rowIndex < excelData.length; rowIndex++) {
                        const location = excelData[rowIndex][colIndex];
                        if (location) {
                            try {
                                const parts = location.split('-');
                                if (parts.length >= 3) {
                                    const level = parseInt(parts[1]);
                                    const bay = parseInt(parts[2]);
                                    
                                    if (!rackDict[level]) {
                                        rackDict[level] = {};
                                    }
                                    rackDict[level][bay] = location;
                                }
                            } catch (e) {
                                // Skip invalid locations
                            }
                        }
                    }

                    // Build matrix
                    if (Object.keys(rackDict).length > 0) {
                        const maxLevel = Math.max(...Object.keys(rackDict).map(Number));
                        const maxBay = Math.max(...Object.values(rackDict).map(levelData => 
                            Math.max(...Object.keys(levelData).map(Number))
                        ));

                        // Create matrix (top level first)
                        for (let level = maxLevel; level >= 1; level--) {
                            const row = [];
                            for (let bay = 1; bay <= maxBay; bay++) {
                                if (rackDict[level] && rackDict[level][bay]) {
                                    const location = rackDict[level][bay];
                                    rackData.totalLocations++;

                                    const items = stockByLocation[location] || [];
                                    const occupied = items.length > 0;

                                    if (occupied) {
                                        rackData.occupiedLocations++;
                                    }

                                    row.push({
                                        location: location,
                                        occupied: occupied,
                                        items: items
                                    });
                                } else {
                                    row.push(null);
                                }
                            }
                            zoneData.matrix.push(row);
                        }
                    }

                    rackData.zones[zoneName] = zoneData;
                });
            }

            return rackData;
        }

        function formatDateToDDMMYYYY(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function reloadDataDisplay() {
            // Clear existing data
            allCells.clear();
            allCustomers.clear();
            customerCounts = {};
            selectedCustomers.clear();
            
            // Reload with new data
            loadData();
        }

        async function loadInitialData() {
            try {
                // Load data from JSON file
                const response = await fetch('rack_data.json');
                if (!response.ok) {
                    throw new Error('Failed to load rack_data.json');
                }
                RACK_DATA = await response.json();
                
                loadData();
            } catch (error) {
                document.getElementById('loadingMessage').innerHTML = 
                    '<span style="color: red;">Error loading initial data: ' + error.message + '<br>Please use the "Load Files" button to load your data.</span>';
                console.error('Error loading initial data:', error);
            }
        }

        // Helper function to parse DD/MM/YYYY dates
        function parseDDMMYYYY(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('/');
            if (parts.length !== 3) return null;
            // parts[0] = day, parts[1] = month, parts[2] = year
            // JavaScript Date months are 0-indexed, so subtract 1 from month
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            const date = new Date(year, month, day);
            // Validate the date
            if (isNaN(date.getTime())) return null;
            return date;
        }

        function loadData() {
            try {
                // Use the latest date from data if available
                if (RACK_DATA.latestDate) {
                    latestDate = parseDDMMYYYY(RACK_DATA.latestDate);
                } else {
                    latestDate = null;
                }
                
                for (const [zoneName, zoneData] of Object.entries(RACK_DATA.zones)) {
                    for (const row of zoneData.matrix) {
                        for (const cell of row) {
                            if (cell && cell.occupied && cell.items.length > 0) {
                                cell.items.forEach(item => {
                                    if (item.ownerName) {
                                        allCustomers.add(item.ownerName);
                                        customerCounts[item.ownerName] = (customerCounts[item.ownerName] || 0) + 1;
                                    }
                                });
                            }
                        }
                    }
                }
                
                populateCustomerList();
                displayTabs();
                updateStats();
                document.getElementById('loadingMessage').style.display = 'none';
            } catch (error) {
                document.getElementById('loadingMessage').innerHTML = 
                    '<span style="color: red;">Error loading data: ' + error.message + '</span>';
                console.error('Error loading data:', error);
            }
        }

        function populateCustomerList() {
            const customerList = document.getElementById('customerList');
            
            const allItem = document.createElement('div');
            allItem.className = 'customer-item all-customers selected';
            allItem.innerHTML = `
                <input type="checkbox" class="customer-checkbox" checked onchange="toggleAllCustomers(this)">
                <span class="customer-name">All Customers</span>
                <span class="customer-count">(${RACK_DATA.occupiedLocations})</span>
            `;
            customerList.appendChild(allItem);

            const sortedCustomers = Array.from(allCustomers).sort();

            sortedCustomers.forEach(customer => {
                const item = document.createElement('div');
                item.className = 'customer-item';
                item.dataset.customer = customer;
                item.innerHTML = `
                    <input type="checkbox" class="customer-checkbox" onchange="toggleCustomer('${customer.replace(/'/g, "\\'")}', this)">
                    <span class="customer-name">${customer}</span>
                    <span class="customer-count">(${customerCounts[customer]})</span>
                `;
                item.onclick = function(e) {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = this.querySelector('.customer-checkbox');
                        checkbox.checked = !checkbox.checked;
                        checkbox.onchange();
                    }
                };
                customerList.appendChild(item);
            });
        }

        function toggleAllCustomers(checkbox) {
            const allItem = checkbox.closest('.customer-item');
            const customerCheckboxes = document.querySelectorAll('.customer-item:not(.all-customers) .customer-checkbox');
            
            if (checkbox.checked) {
                selectedCustomers.clear();
                customerCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.closest('.customer-item').classList.remove('selected');
                });
                allItem.classList.add('selected');
            } else {
                checkbox.checked = true;
            }
            
            applyCustomerFilter();
        }

        function toggleCustomer(customerName, checkbox) {
            const allCheckbox = document.querySelector('.all-customers .customer-checkbox');
            const allItem = allCheckbox.closest('.customer-item');
            const item = checkbox.closest('.customer-item');
            
            if (checkbox.checked) {
                allCheckbox.checked = false;
                allItem.classList.remove('selected');
                selectedCustomers.add(customerName);
                item.classList.add('selected');
            } else {
                selectedCustomers.delete(customerName);
                item.classList.remove('selected');
                
                if (selectedCustomers.size === 0) {
                    allCheckbox.checked = true;
                    allItem.classList.add('selected');
                }
            }
            
            applyCustomerFilter();
        }

        function applyCustomerFilter() {
            applyFilter();
        }

        function getStockAgeInMonths(lot6Date) {
            if (!lot6Date || !latestDate) return null;
            
            // Parse the date string using DD/MM/YYYY format
            const itemDate = parseDDMMYYYY(lot6Date);
            if (!itemDate) return null;
            
            // Calculate difference in months from the latest date
            const monthsDiff = (latestDate.getFullYear() - itemDate.getFullYear()) * 12 + 
                              (latestDate.getMonth() - itemDate.getMonth());
            
            return monthsDiff;
        }

        function matchesAgingFilter(item) {
            // Get selected aging filter
            const agingAll = document.getElementById('agingAll')?.checked || false;
            const aging6months = document.getElementById('aging6months')?.checked || false;
            const aging1year = document.getElementById('aging1year')?.checked || false;
            const aging2years = document.getElementById('aging2years')?.checked || false;
            const agingOver2years = document.getElementById('agingOver2years')?.checked || false;
            
            console.log(`[matchesAgingFilter] Radio states - All:${agingAll}, ‚â§6m:${aging6months}, >6m:${aging1year}, >1y:${aging2years}, >2y:${agingOver2years}`);
            
            // If "All" is selected, show everything
            if (agingAll) {
                return true;
            }
            
            const ageInMonths = getStockAgeInMonths(item.lot6);
            
            console.log(`Item ${item.itemCode} - lot6: ${item.lot6}, ageInMonths: ${ageInMonths}, latestDate: ${latestDate}`);
            
            // If no valid date, don't filter it out (show it)
            if (ageInMonths === null) {
                console.log(`  -> Showing (no valid date)`);
                return true;
            }
            
            // Cumulative aging filters
            if (aging6months) {
                // Show items 0-6 months old
                const matches = ageInMonths <= 6;
                console.log(`  -> ‚â§6 months filter: ${matches} (age: ${ageInMonths})`);
                return matches;
            }
            if (aging1year) {
                // Show items older than 6 months (includes > 1 year and > 2 years)
                const matches = ageInMonths > 6;
                console.log(`  -> >6 months filter: ${matches} (age: ${ageInMonths})`);
                return matches;
            }
            if (aging2years) {
                // Show items older than 1 year (includes > 2 years)
                const matches = ageInMonths > 12;
                console.log(`  -> >1 year filter: ${matches} (age: ${ageInMonths})`);
                return matches;
            }
            if (agingOver2years) {
                // Show items older than 2 years
                const matches = ageInMonths > 24;
                console.log(`  -> >2 years filter: ${matches} (age: ${ageInMonths})`);
                return matches;
            }
            
            console.log(`  -> NO FILTER MATCHED - returning false`);
            return false;
        }

        function applyFilter() {
            console.log('=== applyFilter called ===');
            const showAllCustomers = selectedCustomers.size === 0;
            console.log('Show all customers:', showAllCustomers);
            
            let totalCells = 0;
            let filteredOutCells = 0;
            
            allCells.forEach((cell, location) => {
                totalCells++;
                const cellData = findCellData(location);
                
                if (!cellData || !cellData.occupied) {
                    cell.classList.remove('filtered-out');
                    return;
                }
                
                // Check if any item in the cell matches both filters
                const hasMatchingItem = cellData.items.some(item => {
                    // Check customer filter
                    const matchesCustomer = showAllCustomers || selectedCustomers.has(item.ownerName);
                    
                    // Check aging filter
                    const matchesAging = matchesAgingFilter(item);
                    
                    console.log(`  Location ${location}: customer=${matchesCustomer}, aging=${matchesAging}, both=${matchesCustomer && matchesAging}`);
                    
                    // Item must match both filters
                    return matchesCustomer && matchesAging;
                });
                
                if (hasMatchingItem) {
                    cell.classList.remove('filtered-out');
                } else {
                    cell.classList.add('filtered-out');
                    filteredOutCells++;
                }
            });
            
            console.log(`Total cells: ${totalCells}, Filtered out: ${filteredOutCells}`);
            
            // Update empty tabs after filtering
            checkAndUpdateEmptyTabs();
        }

        function findCellData(location) {
            for (const [zoneName, zoneData] of Object.entries(RACK_DATA.zones)) {
                for (const row of zoneData.matrix) {
                    for (const cell of row) {
                        if (cell && cell.location === location) {
                            return cell;
                        }
                    }
                }
            }
            return null;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const button = document.getElementById('sidebarToggle');
            
            sidebarVisible = !sidebarVisible;
            
            if (sidebarVisible) {
                sidebar.classList.remove('hidden');
                button.textContent = 'Hide';
            } else {
                sidebar.classList.add('hidden');
                button.textContent = 'Show';
            }
            
            if (currentZoom === 'fit') {
                setTimeout(() => setZoom('fit'), 300);
            }
        }

        function switchMainTab(tabName) {
            currentMainTab = tabName;
            
            const rackContainer = document.getElementById('rackContainer');
            const analyzeContainer = document.getElementById('analyzeContainer');
            const zoneTabs = document.querySelectorAll('.tab:not([onclick*="switchMainTab"])');
            const analyzeTab = document.querySelector('.tab[onclick*="switchMainTab"]');
            
            if (tabName === 'analyze') {
                rackContainer.style.display = 'none';
                analyzeContainer.classList.add('active');
                zoneTabs.forEach(tab => tab.classList.remove('active'));
                analyzeTab.classList.add('active');
            } else {
                rackContainer.style.display = 'block';
                analyzeContainer.classList.remove('active');
                analyzeTab.classList.remove('active');
                
                if (currentZone) {
                    const activeZoneTab = Array.from(zoneTabs).find(tab => tab.textContent === currentZone);
                    if (activeZoneTab) activeZoneTab.classList.add('active');
                }
            }
        }

        function setZoom(zoomLevel) {
            const container = document.getElementById('rackContainer');
            const matrices = document.querySelectorAll('.rack-matrix');
            
            document.querySelectorAll('.control-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (zoomLevel === '100') {
                document.getElementById('zoom100').classList.add('active');
                matrices.forEach(matrix => {
                    matrix.style.transform = 'scale(1)';
                });
            } else if (zoomLevel === '75') {
                document.getElementById('zoom75').classList.add('active');
                matrices.forEach(matrix => {
                    matrix.style.transform = 'scale(0.75)';
                });
            } else if (zoomLevel === 'fit') {
                document.getElementById('zoomFit').classList.add('active');
                
                const containerWidth = container.clientWidth - 40;
                const cellWidth = 120;
                const cellGap = 3;
                const rowLabelWidth = 55;
                const matrixPadding = 30;
                
                const totalNeededWidth = rowLabelWidth + (24 * cellWidth) + (23 * cellGap) + matrixPadding;
                const scaleFactor = containerWidth / totalNeededWidth;
                const finalScale = Math.min(scaleFactor, 1);
                
                matrices.forEach(matrix => {
                    matrix.style.transform = `scale(${finalScale})`;
                });
            }
            
            currentZoom = zoomLevel;
        }

        function displayTabs() {
            const tabsContainer = document.getElementById('tabs');
            const zoneContents = document.getElementById('zoneContents');
            
            const zoneNames = Object.keys(RACK_DATA.zones).sort((a, b) => {
                const order = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','X','O','P','Q','R','S',
                               'LL','MM','NN','OO','PP','QQ','RR','SS','TT','UU','VV','WW','XX','YY',
                               'Z1','Z2','Z3','Z4','Z5','Z6'];
                return order.indexOf(a) - order.indexOf(b);
            });

            zoneNames.forEach((zoneName) => {
                const tab = document.createElement('button');
                tab.className = 'tab';
                tab.textContent = zoneName;
                tab.onclick = () => switchZone(zoneName);
                tabsContainer.appendChild(tab);

                const zoneDiv = document.createElement('div');
                zoneDiv.className = 'zone-content';
                zoneDiv.id = `zone-${zoneName}`;
                
                const matrix = document.createElement('div');
                matrix.className = 'rack-matrix';
                
                const zoneData = RACK_DATA.zones[zoneName];
                const reversedMatrix = [...zoneData.matrix].reverse();
                
                reversedMatrix.forEach((row, rowIndex) => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'rack-row';
                    
                    const levelNumber = zoneData.matrix.length - rowIndex;
                    
                    const rowLabel = document.createElement('div');
                    rowLabel.className = 'row-label';
                    rowLabel.textContent = `Level ${levelNumber}`;
                    rowDiv.appendChild(rowLabel);
                    
                    row.forEach((cell) => {
                        if (cell) {
                            const cellDiv = createRackCell(cell);
                            rowDiv.appendChild(cellDiv);
                        } else {
                            const emptyDiv = document.createElement('div');
                            emptyDiv.className = 'rack-cell empty';
                            emptyDiv.style.visibility = 'hidden';
                            rowDiv.appendChild(emptyDiv);
                        }
                    });
                    
                    matrix.appendChild(rowDiv);
                });
                
                zoneDiv.appendChild(matrix);
                zoneContents.appendChild(zoneDiv);
            });

            if (zoneNames.length > 0) {
                switchZone(zoneNames[0]);
            }
            
            // Check and update empty tabs after creating racks
            checkAndUpdateEmptyTabs();
        }

        function createRackCell(location) {
            const cell = document.createElement('div');
            const isOccupied = location.occupied && location.items.length > 0;
            
            cell.className = `rack-cell ${isOccupied ? 'occupied' : 'empty'}`;
            cell.dataset.location = location.location;
            
            allCells.set(location.location, cell);

            const locDiv = document.createElement('div');
            locDiv.className = 'cell-location';
            locDiv.textContent = location.location;
            cell.appendChild(locDiv);

            if (isOccupied) {
                const firstItem = location.items[0];
                const ownerName = firstItem.ownerName;
                
                if (RACK_DATA.ownerColors[ownerName]) {
                    cell.style.backgroundColor = RACK_DATA.ownerColors[ownerName];
                }

                const ownerDiv = document.createElement('div');
                ownerDiv.className = 'cell-owner';
                ownerDiv.textContent = ownerName.substring(0, 20);
                ownerDiv.title = ownerName;
                cell.appendChild(ownerDiv);

                const itemDiv = document.createElement('div');
                itemDiv.className = 'cell-item';
                itemDiv.textContent = firstItem.itemCode;
                cell.appendChild(itemDiv);

                const nameDiv = document.createElement('div');
                nameDiv.className = 'cell-item';
                nameDiv.textContent = firstItem.itemName.substring(0, 15) + (firstItem.itemName.length > 15 ? '...' : '');
                cell.appendChild(nameDiv);

                const qtyDiv = document.createElement('div');
                qtyDiv.className = 'cell-qty';
                qtyDiv.textContent = `${firstItem.qty} ${firstItem.uom}`;
                cell.appendChild(qtyDiv);

                if (location.items.length > 1) {
                    const badge = document.createElement('div');
                    badge.className = 'cell-badge';
                    badge.textContent = location.items.length;
                    badge.title = `${location.items.length} items`;
                    cell.appendChild(badge);
                }
            }

            cell.addEventListener('click', () => showLocationModal(location));

            return cell;
        }

        function showLocationModal(location) {
            const modal = document.getElementById('locationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `Location: ${location.location}`;

            if (!location.occupied || location.items.length === 0) {
                modalBody.innerHTML = `
                    <div class="empty-location">
                        <div style="font-size: 3em; margin-bottom: 15px;">üì¶</div>
                        <div>This location is currently empty</div>
                    </div>
                `;
            } else {
                let html = '';
                location.items.forEach((item, index) => {
                    html += `
                        <div class="item-card">
                            <h3>Item ${index + 1}</h3>
                            <div class="item-info">
                                <div class="info-row">
                                    <span class="info-label">Owner Name</span>
                                    <span class="info-value">${item.ownerName}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Item Code</span>
                                    <span class="info-value">${item.itemCode}</span>
                                </div>
                                <div class="info-row" style="grid-column: 1 / -1;">
                                    <span class="info-label">Item Name</span>
                                    <span class="info-value">${item.itemName}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Quantity</span>
                                    <span class="info-value">${item.stockQty || item.qty} ${item.uom}</span>
                                </div>
                                ${item.lot6 ? `
                                <div class="info-row">
                                    <span class="info-label">Lot6 (Date)</span>
                                    <span class="info-value">${item.lot6}</span>
                                </div>
                                ` : ''}
                                ${item.lot2 ? `
                                <div class="info-row">
                                    <span class="info-label">Lot2</span>
                                    <span class="info-value">${item.lot2}</span>
                                </div>
                                ` : ''}
                                ${item.damageFlag ? `
                                <div class="info-row">
                                    <span class="info-label">Damage Flag</span>
                                    <span class="info-value" style="font-weight: 600; color: ${item.damageFlag === 'Good' ? '#28a745' : (item.damageFlag === 'Held' ? '#ffc107' : '#dc3545')}">${item.damageFlag}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                modalBody.innerHTML = html;
            }

            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('locationModal').style.display = 'none';
        }

        function switchZone(zoneName) {
            currentMainTab = 'rack';
            
            const rackContainer = document.getElementById('rackContainer');
            const analyzeContainer = document.getElementById('analyzeContainer');
            const analyzeTab = document.querySelector('.tab[onclick*="switchMainTab"]');
            
            rackContainer.style.display = 'block';
            analyzeContainer.classList.remove('active');
            analyzeTab.classList.remove('active');
            
            document.querySelectorAll('.tab:not([onclick*="switchMainTab"])').forEach(tab => {
                if (tab.textContent === zoneName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            document.querySelectorAll('.zone-content').forEach(content => {
                if (content.id === `zone-${zoneName}`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            currentZone = zoneName;
            
            if (currentZoom) {
                setTimeout(() => setZoom(currentZoom), 50);
            }
        }

        function updateStats() {
            document.getElementById('totalLocations').textContent = RACK_DATA.totalLocations.toLocaleString();
            document.getElementById('occupiedLocations').textContent = RACK_DATA.occupiedLocations.toLocaleString();
            const rate = (RACK_DATA.occupiedLocations / RACK_DATA.totalLocations * 100).toFixed(2);
            document.getElementById('occupancyRate').textContent = rate + '%';
        }

        function renderCustomerChart() {
            const chartContainer = document.getElementById('customerChart');
            
            // Count locations by customer
            const customerLocations = new Map();
            const totalOccupied = RACK_DATA.occupiedLocations;
            
            // Iterate through all zones and cells
            Object.values(RACK_DATA.zones).forEach(zone => {
                zone.matrix.forEach(row => {
                    row.forEach(cell => {
                        if (cell && cell.occupied && cell.items && cell.items.length > 0) {
                            const customer = cell.items[0].ownerName; // Use first item's owner
                            customerLocations.set(customer, (customerLocations.get(customer) || 0) + 1);
                        }
                    });
                });
            });
            
            // Convert to array and sort by count (descending)
            const sortedCustomers = Array.from(customerLocations.entries())
                .sort((a, b) => b[1] - a[1]);
            
            // Generate HTML for bars
            let html = '';
            sortedCustomers.forEach(([customer, count]) => {
                const percentage = ((count / totalOccupied) * 100).toFixed(1);
                const color = RACK_DATA.ownerColors[customer] || '#667eea';
                
                html += `
                    <div class="chart-bar-item">
                        <div class="chart-bar-label" title="${customer}">${customer}</div>
                        <div class="chart-bar-container">
                            <div class="chart-bar-bg">
                                <div class="chart-bar-fill" style="width: ${percentage}%; background: ${color};">
                                    ${percentage > 10 ? `<span class="chart-bar-percentage">${percentage}%</span>` : ''}
                                </div>
                            </div>
                            <div class="chart-bar-count">${count} (${percentage}%)</div>
                        </div>
                    </div>
                `;
            });
            
            chartContainer.innerHTML = html || '<div style="text-align: center; padding: 40px; color: #6c757d;">No data available</div>';
        }

        function switchMainTab(tabName) {
            currentMainTab = tabName;
            
            const rackContainer = document.getElementById('rackContainer');
            const analyzeContainer = document.getElementById('analyzeContainer');
            const zoneTabs = document.querySelectorAll('.tab:not([onclick*="switchMainTab"])');
            const analyzeTab = document.querySelector('.tab[onclick*="switchMainTab"]');
            
            if (tabName === 'analyze') {
                rackContainer.style.display = 'none';
                analyzeContainer.classList.add('active');
                zoneTabs.forEach(tab => tab.classList.remove('active'));
                analyzeTab.classList.add('active');
                
                // Render customer chart when switching to analyze tab
                renderCustomerChart();
            } else {
                rackContainer.style.display = 'block';
                analyzeContainer.classList.remove('active');
                analyzeTab.classList.remove('active');
                
                if (currentZone) {
                    const activeZoneTab = Array.from(zoneTabs).find(tab => tab.textContent === currentZone);
                    if (activeZoneTab) activeZoneTab.classList.add('active');
                }
            }
        }

        function checkAndUpdateEmptyTabs() {
            // Iterate through all zones to check if they're empty
            Object.keys(RACK_DATA.zones).forEach(zoneName => {
                const zoneData = RACK_DATA.zones[zoneName];
                let hasVisibleOccupiedLocation = false;
                
                // Check if any location in this zone is occupied and visible (not filtered out)
                for (const row of zoneData.matrix) {
                    for (const cell of row) {
                        if (cell && cell.occupied && cell.items && cell.items.length > 0) {
                            // Check if this cell is visible (not filtered out)
                            const cellElement = allCells.get(cell.location);
                            if (cellElement && !cellElement.classList.contains('filtered-out')) {
                                hasVisibleOccupiedLocation = true;
                                break;
                            }
                        }
                    }
                    if (hasVisibleOccupiedLocation) break;
                }
                
                // Find the tab button for this zone and update its class
                const tabs = document.querySelectorAll('.tab:not([onclick*="switchMainTab"])');
                tabs.forEach(tab => {
                    if (tab.textContent === zoneName) {
                        if (!hasVisibleOccupiedLocation) {
                            tab.classList.add('empty-tab');
                        } else {
                            tab.classList.remove('empty-tab');
                        }
                    }
                });
            });
        }

        function searchLocation() {
            const searchTerm = document.getElementById('searchInput').value.trim().toUpperCase();
            if (!searchTerm) return;

            clearSearch();

            let found = false;
            let foundZone = null;

            for (const [zoneName, zoneData] of Object.entries(RACK_DATA.zones)) {
                for (const row of zoneData.matrix) {
                    for (const cell of row) {
                        if (cell && cell.location.toUpperCase().includes(searchTerm)) {
                            found = true;
                            foundZone = zoneName;
                            
                            const cellElement = allCells.get(cell.location);
                            if (cellElement) {
                                cellElement.classList.add('highlight');
                            }
                        }
                    }
                }
            }

            if (found && foundZone) {
                switchZone(foundZone);
                
                setTimeout(() => {
                    const highlightedCell = document.querySelector('.rack-cell.highlight');
                    if (highlightedCell) {
                        highlightedCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            } else {
                alert(`Location "${searchTerm}" not found`);
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('.rack-cell.highlight').forEach(cell => {
                cell.classList.remove('highlight');
            });
        }

        window.onclick = function(event) {
            const modal = document.getElementById('locationModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        window.addEventListener('resize', function() {
            if (currentZoom === 'fit') {
                setZoom('fit');
            }
        });
    </script>
</body>
</html>
