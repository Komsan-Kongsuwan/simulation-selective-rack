<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Rack Visualization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 24px;
            color: #2c3e50;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            width: 200px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #3498db;
        }

        .zoom-controls {
            display: flex;
            gap: 5px;
        }

        .zoom-btn, .filter-toggle-btn {
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .zoom-btn:hover, .filter-toggle-btn:hover {
            background: #2980b9;
        }

        .zoom-btn.active {
            background: #2980b9;
        }

        .main-content {
            display: flex;
            gap: 0;
        }

        .sidebar {
            width: 250px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 70vh;
            overflow-y: auto;
            transition: all 0.3s;
        }

        .sidebar.hidden {
            width: 0;
            padding: 0;
            overflow: hidden;
        }

        .sidebar h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .customer-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .customer-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border-radius: 4px;
            transition: background 0.2s;
            font-size: 0.75em;
        }

        .customer-item:hover {
            background: #e9ecef;
        }

        .customer-item input[type="checkbox"] {
            cursor: pointer;
        }

        .customer-item label {
            cursor: pointer;
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .customer-count {
            font-size: 0.7em;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .rack-container {
            flex: 1;
            overflow-x: auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: #ecf0f1;
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            color: #2c3e50;
        }

        .tab:hover {
            background: #d5dbdb;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab.full-zone {
            color: #27ae60;
            font-weight: bold;
        }

        .rack-view {
            display: none;
        }

        .rack-view.active {
            display: block;
        }

        .rack-matrix {
            display: inline-block;
            min-width: min-content;
        }

        .rack-row {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .level-label {
            width: 80px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-weight: bold;
            color: #34495e;
            font-size: 14px;
        }

        .rack-cell {
            width: 120px;
            height: 90px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            padding: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            position: relative;
            background: white;
        }

        .rack-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .rack-cell.empty {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            cursor: default;
        }

        .rack-cell.empty:hover {
            transform: none;
            box-shadow: none;
        }

        .rack-cell.filtered-empty {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            cursor: default;
        }

        .rack-cell.filtered-empty:hover {
            transform: none;
            box-shadow: none;
        }

        .rack-cell.filtered-empty .location-id {
            color: #000000 !important;
        }

        .rack-cell.filtered-empty .owner-name,
        .rack-cell.filtered-empty .item-code,
        .rack-cell.filtered-empty .item-name,
        .rack-cell.filtered-empty .quantity,
        .rack-cell.filtered-empty .item-badge {
            display: none;
        }

        .rack-cell.empty .location-id {
            color: #adb5bd;
        }

        .rack-cell.highlighted {
            border: 3px solid #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }

        .location-id {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 2px;
            font-size: 10px;
        }

        .owner-name {
            color: #34495e;
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .item-code {
            color: #7f8c8d;
            font-size: 9px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-name {
            color: #7f8c8d;
            font-size: 9px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .quantity {
            color: #27ae60;
            font-size: 9px;
            font-weight: bold;
        }

        .item-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 9px;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-header h2 {
            color: #2c3e50;
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #e74c3c;
        }

        .item-details {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .item-details:last-child {
            margin-bottom: 0;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .detail-row:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: bold;
            color: #34495e;
        }

        .detail-value {
            color: #2c3e50;
        }

        .status-movable {
            color: #27ae60;
            font-weight: bold;
        }

        .status-hold {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-damaged {
            color: #e67e22;
            font-weight: bold;
        }

        /* Analyze Tab Styles */
        .analyze-container {
            padding: 20px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .zone-analysis {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .zone-analysis h3 {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .zone-table {
            width: 100%;
            border-collapse: collapse;
        }

        .zone-table thead {
            background: #34495e;
            color: white;
        }

        .zone-table th {
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
        }

        .zone-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 13px;
        }

        .zone-table tbody tr:hover {
            background: #f8f9fa;
        }

        .zone-table .zone-col {
            font-weight: bold;
            color: #3498db;
        }

        .zone-table .pct-col {
            font-weight: bold;
        }

        .pct-high {
            color: #27ae60;
        }

        .pct-medium {
            color: #f39c12;
        }

        .pct-low {
            color: #e74c3c;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #7f8c8d;
        }

        @media (max-width: 1200px) {
            .sidebar {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
                margin-bottom: 20px;
            }

            .sidebar.hidden {
                max-height: 0;
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Warehouse Rack Visualization</h1>
            <div class="controls">
                <input type="text" class="search-box" id="searchBox" placeholder="Search location (e.g., A-1-24)">
                <div class="zoom-controls">
                    <button class="zoom-btn active" data-zoom="100">100%</button>
                    <button class="zoom-btn" data-zoom="75">75%</button>
                    <button class="zoom-btn" data-zoom="fit">Fit Width</button>
                </div>
                <button class="filter-toggle-btn" id="filterToggle">Hide Filters</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar" id="sidebar">
                <h3>Filter by Customer</h3>
                <div class="customer-list" id="customerList">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <div class="rack-container" id="rackContainer">
                <div class="tabs" id="tabs">
                    <div class="loading">Loading data...</div>
                </div>
                
                <div id="rackViews">
                    <!-- Rack views will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Location Details</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Load the rack data from external file -->
    <script src="rack_data.js"></script>
    
    <script>
        // Application state
        let currentZone = 'Analyze';
        let currentZoom = 100;
        let selectedCustomers = new Set();
        let allCustomers = new Set();
        let customerItemCounts = {};

        // Initialize the application
        function init() {
            // Check if data is loaded
            if (typeof rackData === 'undefined' || typeof analyzeData === 'undefined') {
                alert('Error: Data file not loaded. Please make sure rack_data.js is in the same directory.');
                return;
            }

            collectAllCustomers();
            createTabs();
            createCustomerFilter();
            createAnalyzeView();
            createRackViews();
            setupEventListeners();
            switchZone('Analyze');
        }

        // Collect all unique customers and their item counts
        function collectAllCustomers() {
            for (const zone in rackData) {
                for (const level in rackData[zone]) {
                    for (const bay in rackData[zone][level]) {
                        const location = rackData[zone][level][bay];
                        if (location.items) {
                            location.items.forEach(item => {
                                const owner = item.owner;
                                allCustomers.add(owner);
                                customerItemCounts[owner] = (customerItemCounts[owner] || 0) + 1;
                            });
                        }
                    }
                }
            }
        }

        // Create tabs
        function createTabs() {
            const tabsContainer = document.getElementById('tabs');
            tabsContainer.innerHTML = '';
            
            // Analyze tab
            const analyzeTab = document.createElement('button');
            analyzeTab.className = 'tab active';
            analyzeTab.textContent = 'Analyze';
            analyzeTab.dataset.zone = 'Analyze';
            tabsContainer.appendChild(analyzeTab);

            // Zone tabs
            const zones = Object.keys(rackData).sort((a, b) => {
                const getOrder = (z) => {
                    if (z.length === 1) return [1, z.charCodeAt(0), 0];
                    if (z.length === 2 && z[1] >= '1' && z[1] <= '6') return [3, z.charCodeAt(0), parseInt(z[1])];
                    return [2, z.charCodeAt(0), z.charCodeAt(1)];
                };
                const [aType, aChar, aNum] = getOrder(a);
                const [bType, bChar, bNum] = getOrder(b);
                if (aType !== bType) return aType - bType;
                if (aChar !== bChar) return aChar - bChar;
                return aNum - bNum;
            });

            zones.forEach(zone => {
                const tab = document.createElement('button');
                tab.className = 'tab';
                tab.textContent = zone;
                tab.dataset.zone = zone;
                tabsContainer.appendChild(tab);
            });
        }

        // Create customer filter
        function createCustomerFilter() {
            const customerList = document.getElementById('customerList');
            customerList.innerHTML = '';
            
            // "All Customers" option
            const allItem = document.createElement('div');
            allItem.className = 'customer-item';
            allItem.innerHTML = `
                <input type="checkbox" id="customer-all" checked>
                <label for="customer-all">
                    <span>All Customers</span>
                </label>
            `;
            customerList.appendChild(allItem);

            // Individual customers
            const sortedCustomers = Array.from(allCustomers).sort();
            sortedCustomers.forEach(customer => {
                const count = customerItemCounts[customer] || 0;
                const item = document.createElement('div');
                item.className = 'customer-item';
                const customerId = 'customer-' + customer.replace(/[^a-zA-Z0-9]/g, '');
                item.innerHTML = `
                    <input type="checkbox" id="${customerId}" data-customer="${customer}" class="customer-checkbox" checked>
                    <label for="${customerId}">
                        <span>${customer.substring(0, 30)}</span>
                        <span class="customer-count">${count}</span>
                    </label>
                `;
                customerList.appendChild(item);
            });

            // Initialize all customers as selected
            selectedCustomers = new Set(allCustomers);
        }

        // Create Analyze view with visualizations
        function createAnalyzeView() {
            const rackViews = document.getElementById('rackViews');
            const analyzeView = document.createElement('div');
            analyzeView.className = 'rack-view';
            analyzeView.id = 'zone-Analyze';

            // Calculate totals
            let totalCapacity = 0;
            let totalUsed = 0;
            analyzeData.forEach(row => {
                totalCapacity += row.capacity;
                totalUsed += row.used;
            });
            const occupancyRate = ((totalUsed / totalCapacity) * 100).toFixed(1);

            analyzeView.innerHTML = `
                <div class="analyze-container">
                    <div class="stats-overview">
                        <div class="stat-card blue">
                            <div class="stat-value">${totalCapacity.toLocaleString()}</div>
                            <div class="stat-label">Total Locations</div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-value">${totalUsed.toLocaleString()}</div>
                            <div class="stat-label">Occupied Locations</div>
                        </div>
                        <div class="stat-card orange">
                            <div class="stat-value">${occupancyRate}%</div>
                            <div class="stat-label">Occupancy Rate</div>
                        </div>
                    </div>

                    <div class="zone-analysis">
                        <h3>üìä Zone Analysis</h3>
                        <table class="zone-table">
                            <thead>
                                <tr>
                                    <th>Zone</th>
                                    <th>Capacity</th>
                                    <th>L1</th>
                                    <th>L2</th>
                                    <th>L3</th>
                                    <th>L4</th>
                                    <th>L5</th>
                                    <th>L6</th>
                                    <th>L7</th>
                                    <th>Used</th>
                                    <th>Empty</th>
                                    <th>Occupied %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${analyzeData.map(row => {
                                    const pct = (row.occupiedPct * 100).toFixed(1);
                                    let pctClass = 'pct-low';
                                    if (pct >= 70) pctClass = 'pct-high';
                                    else if (pct >= 40) pctClass = 'pct-medium';

                                    return `
                                        <tr>
                                            <td class="zone-col">${row.zone}</td>
                                            <td>${row.capacity}</td>
                                            <td>${row.level1}</td>
                                            <td>${row.level2}</td>
                                            <td>${row.level3}</td>
                                            <td>${row.level4}</td>
                                            <td>${row.level5}</td>
                                            <td>${row.level6}</td>
                                            <td>${row.level7}</td>
                                            <td><strong>${row.used}</strong></td>
                                            <td>${row.empty}</td>
                                            <td class="pct-col ${pctClass}">${pct}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            rackViews.appendChild(analyzeView);
        }

        // Create rack views
        function createRackViews() {
            const rackViews = document.getElementById('rackViews');

            for (const zone in rackData) {
                const zoneView = document.createElement('div');
                zoneView.className = 'rack-view';
                zoneView.id = `zone-${zone}`;
                
                const matrix = createMatrix(zone);
                const matrixDiv = document.createElement('div');
                matrixDiv.className = 'rack-matrix';
                matrixDiv.innerHTML = matrix;
                
                zoneView.appendChild(matrixDiv);
                rackViews.appendChild(zoneView);
            }
        }

        // Create matrix for a zone
        function createMatrix(zone) {
            let html = '';
            
            // Create 7 rows (levels 7 to 1, top to bottom)
            for (let level = 7; level >= 1; level--) {
                html += '<div class="rack-row">';
                html += `<div class="level-label">Level ${level}</div>`;
                
                // Create 24 columns (bays 1 to 24)
                for (let bay = 1; bay <= 24; bay++) {
                    const location = rackData[zone]?.[level]?.[bay];
                    
                    if (location && location.items && location.items.length > 0) {
                        const firstItem = location.items[0];
                        const itemCount = location.items.length;
                        const color = getOwnerColor(firstItem.owner);
                        
                        html += `
                            <div class="rack-cell" 
                                 data-zone="${zone}" 
                                 data-level="${level}" 
                                 data-bay="${bay}"
                                 data-owner="${firstItem.owner}"
                                 style="background-color: ${color}20; border-color: ${color};">
                                <div class="location-id">${location.location}</div>
                                <div class="owner-name">${truncate(firstItem.owner, 20)}</div>
                                <div class="item-code">${firstItem.itemCode}</div>
                                <div class="item-name">${truncate(firstItem.itemName, 15)}</div>
                                <div class="quantity">${firstItem.quantity} ${firstItem.uom}</div>
                                ${itemCount > 1 ? `<div class="item-badge">${itemCount}</div>` : ''}
                            </div>
                        `;
                    } else {
                        const locationId = `${zone}-${level}-${bay}`;
                        html += `
                            <div class="rack-cell empty" data-location="${locationId}">
                                <div class="location-id">${locationId}</div>
                            </div>
                        `;
                    }
                }
                
                html += '</div>';
            }
            
            return html;
        }

        // Get color for owner
        function getOwnerColor(owner) {
            if (!owner) return '#95a5a6';
            
            // Simple hash function
            let hash = 0;
            for (let i = 0; i < owner.length; i++) {
                hash = owner.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const colors = [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#e67e22', '#34495e', '#16a085', '#27ae60',
                '#2980b9', '#8e44ad', '#c0392b', '#d35400', '#7f8c8d',
                '#c0392b', '#16a085', '#27ae60', '#8e44ad', '#2c3e50',
                '#f1c40f', '#e67e22', '#95a5a6', '#34495e'
            ];
            
            return colors[Math.abs(hash) % colors.length];
        }

        // Truncate text
        function truncate(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) : text;
        }

        // Switch zone
        function switchZone(zone) {
            currentZone = zone;
            
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.zone === zone) {
                    tab.classList.add('active');
                }
            });

            // Update views
            document.querySelectorAll('.rack-view').forEach(view => {
                view.classList.remove('active');
            });
            
            const targetView = document.getElementById(`zone-${zone}`);
            if (targetView) {
                targetView.classList.add('active');
            }

            // Update tab colors based on filter
            if (zone !== 'Analyze') {
                updateTabColors();
            }
        }

        // Update tab colors based on occupancy when filtered
        function updateTabColors() {
            if (selectedCustomers.size === allCustomers.size) {
                // All customers selected - remove green highlighting
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('full-zone');
                });
                return;
            }

            // Check each zone
            for (const zone in rackData) {
                let hasAnyLocation = false;
                let allOccupied = true;

                for (let level = 1; level <= 7; level++) {
                    for (let bay = 1; bay <= 24; bay++) {
                        const location = rackData[zone]?.[level]?.[bay];
                        
                        if (location && location.items && location.items.length > 0) {
                            // Check if any item belongs to selected customers
                            const hasSelectedCustomer = location.items.some(item => 
                                selectedCustomers.has(item.owner)
                            );

                            if (hasSelectedCustomer) {
                                hasAnyLocation = true;
                            }
                        } else {
                            // This is an empty location
                            allOccupied = false;
                        }
                    }
                }

                // Find the tab and update its class
                const tab = document.querySelector(`.tab[data-zone="${zone}"]`);
                if (tab) {
                    if (hasAnyLocation && allOccupied) {
                        tab.classList.add('full-zone');
                    } else {
                        tab.classList.remove('full-zone');
                    }
                }
            }
        }

        // Apply customer filter
        function applyCustomerFilter() {
            const cells = document.querySelectorAll('.rack-cell:not(.empty)');
            
            cells.forEach(cell => {
                const owner = cell.dataset.owner;
                
                if (selectedCustomers.has(owner)) {
                    // Show full details
                    cell.classList.remove('filtered-empty');
                    cell.style.pointerEvents = 'auto';
                } else {
                    // Make it look like empty but keep location ID in black
                    cell.classList.add('filtered-empty');
                    cell.style.pointerEvents = 'none';
                }
            });

            updateTabColors();
        }

        // Show modal with location details
        function showModal(zone, level, bay) {
            const location = rackData[zone]?.[level]?.[bay];
            if (!location || !location.items || location.items.length === 0) return;

            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `Location: ${location.location}`;

            let html = '';
            location.items.forEach((item, index) => {
                const color = getOwnerColor(item.owner);
                
                // Determine status display
                let statusText = 'Movable';
                let statusClass = 'status-movable';
                if (item.damageFlag === 'Held') {
                    statusText = 'Hold';
                    statusClass = 'status-hold';
                } else if (item.damageFlag === 'Damaged') {
                    statusText = 'Damaged';
                    statusClass = 'status-damaged';
                }

                html += `
                    <div class="item-details" style="border-left-color: ${color};">
                        <div class="detail-row">
                            <div class="detail-label">Owner:</div>
                            <div class="detail-value">${item.owner}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Item Code:</div>
                            <div class="detail-value">${item.itemCode}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Item Name:</div>
                            <div class="detail-value">${item.itemName}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Quantity:</div>
                            <div class="detail-value">${item.quantity} ${item.uom}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Status:</div>
                            <div class="detail-value ${statusClass}">${statusText}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Date:</div>
                            <div class="detail-value">${item.lot6 || '-'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Lot1:</div>
                            <div class="detail-value">${item.lot1 || '-'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Lot2:</div>
                            <div class="detail-value">${item.lot2 || '-'}</div>
                        </div>
                    </div>
                `;
            });

            modalBody.innerHTML = html;
            modal.classList.add('active');
        }

        // Search functionality
        function searchLocation(query) {
            query = query.trim().toUpperCase();
            if (!query) {
                clearHighlights();
                return;
            }

            // Remove highlights first
            clearHighlights();

            // Parse the query
            const parts = query.split('-');
            if (parts.length === 3) {
                const [zone, level, bay] = parts;
                
                // Switch to the zone
                if (rackData[zone]) {
                    switchZone(zone);
                    
                    // Highlight the cell
                    setTimeout(() => {
                        const cell = document.querySelector(
                            `.rack-cell[data-zone="${zone}"][data-level="${level}"][data-bay="${bay}"]`
                        );
                        if (cell) {
                            cell.classList.add('highlighted');
                            cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            }
        }

        // Clear highlights
        function clearHighlights() {
            document.querySelectorAll('.rack-cell.highlighted').forEach(cell => {
                cell.classList.remove('highlighted');
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab clicks
            document.getElementById('tabs').addEventListener('click', (e) => {
                if (e.target.classList.contains('tab')) {
                    switchZone(e.target.dataset.zone);
                }
            });

            // Cell clicks
            document.getElementById('rackViews').addEventListener('click', (e) => {
                const cell = e.target.closest('.rack-cell');
                if (cell && !cell.classList.contains('empty') && !cell.classList.contains('filtered-empty')) {
                    const zone = cell.dataset.zone;
                    const level = parseInt(cell.dataset.level);
                    const bay = parseInt(cell.dataset.bay);
                    showModal(zone, level, bay);
                }
            });

            // Modal close
            document.getElementById('closeModal').addEventListener('click', () => {
                document.getElementById('modal').classList.remove('active');
            });

            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target.id === 'modal') {
                    document.getElementById('modal').classList.remove('active');
                }
            });

            // Zoom controls
            document.querySelectorAll('.zoom-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.zoom-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const zoom = btn.dataset.zoom;
                    const rackContainer = document.getElementById('rackContainer');
                    const matrices = document.querySelectorAll('.rack-matrix');
                    
                    if (zoom === 'fit') {
                        rackContainer.style.overflow = 'hidden';
                        matrices.forEach(matrix => {
                            const containerWidth = rackContainer.clientWidth - 40;
                            const matrixWidth = 80 + (24 * 125);
                            const scale = containerWidth / matrixWidth;
                            matrix.style.transform = `scale(${scale})`;
                            matrix.style.transformOrigin = 'top left';
                        });
                    } else {
                        const scale = parseInt(zoom) / 100;
                        rackContainer.style.overflow = 'auto';
                        matrices.forEach(matrix => {
                            matrix.style.transform = `scale(${scale})`;
                            matrix.style.transformOrigin = 'top left';
                        });
                    }
                });
            });

            // Search box
            let searchTimeout;
            document.getElementById('searchBox').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchLocation(e.target.value);
                }, 300);
            });

            // Filter toggle
            document.getElementById('filterToggle').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                const btn = document.getElementById('filterToggle');
                
                if (sidebar.classList.contains('hidden')) {
                    sidebar.classList.remove('hidden');
                    btn.textContent = 'Hide Filters';
                } else {
                    sidebar.classList.add('hidden');
                    btn.textContent = 'Show Filters';
                }
            });

            // Customer filter
            document.getElementById('customerList').addEventListener('change', (e) => {
                if (e.target.id === 'customer-all') {
                    // Toggle all
                    const checkboxes = document.querySelectorAll('.customer-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = e.target.checked;
                    });
                    
                    if (e.target.checked) {
                        selectedCustomers = new Set(allCustomers);
                    } else {
                        selectedCustomers.clear();
                    }
                } else if (e.target.classList.contains('customer-checkbox')) {
                    const customer = e.target.dataset.customer;
                    
                    if (e.target.checked) {
                        selectedCustomers.add(customer);
                    } else {
                        selectedCustomers.delete(customer);
                    }
                    
                    // Update "All Customers" checkbox
                    const allCheckbox = document.getElementById('customer-all');
                    allCheckbox.checked = selectedCustomers.size === allCustomers.size;
                }
                
                applyCustomerFilter();
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
